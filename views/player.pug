extends layout.pug

block append head
    script(src='/javascripts/webgl-heatmap.js')
    script(src='/javascripts/Chart.bundle-2.7.1.min.js')

block scripts
    script
        include chart/chart_helper.js
    script.
        $(function () {
            $('#player-hits-table').DataTable({
                searching: false,
                bInfo : false,
                order: [[ 1,  'desc' ]],
                columnDefs: [ { targets: [ 1 ], visible: true } ]
            });

            $('#btn-view-progression').click(function() {
                location.href = '/players/' + $(this).data('player') + '/progression'
            });
        });
    script.
        var scoresMap = !{JSON.stringify(statistics.hits)};
        $(function () {
            var canvas = $('#dartboard-heatmap')[0];
            drawHeatmap(canvas, scoresMap, 0, 5, 20, 30);
            $("#heatmap-value-selector").change(function () {
                var size = 5;
                var spread = 20;
                var intensity = 30;
                var display = this.value;
                if (display == 2) {
                    size = 10;
                } else if (display == 3) {
                    size = 3
                    spread = 10
                }
                drawHeatmap(canvas, scoresMap, display, size, spread, intensity);
            });
        });

    script.
        var progression = !{JSON.stringify(progression)};
        var labels = [];
        var valuesMap = {
            ppd: [], first9ppd: [],
            scores60s: [], scores100s: [], scores140s: [], scores180s: [] };
        for (var date in progression) {
            if (progression.hasOwnProperty(date)) {
                var p = progression[date];
                labels.push(date);
                valuesMap.ppd.push(p.ppd.toFixed(2));
                valuesMap.first9ppd.push(p.first_nine_ppd.toFixed(2));
                valuesMap.scores60s.push(p.scores_60s_plus);
                valuesMap.scores100s.push(p.scores_100s_plus);
                valuesMap.scores140s.push(p.scores_140s_plus);
                valuesMap.scores180s.push(p.scores_180s);
            }
        }

        $(function () {
            var datasetsPPD = [{
                label: "First 9 PPD",
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: valuesMap.first9ppd,
                fill: false
            },
            {
                label: "PPD",
                backgroundColor: 'rgb(54, 162, 235)',
                borderColor: 'rgb(54, 162, 235)',
                data: valuesMap.ppd,
                fill: false
            }]
            var ppdChart = new Chart("canvas-ppd", getChartConfig('PPD Per Week', 'line', 'Date', 'PPD', labels, datasetsPPD));

            var datasetsScores = [{
                label: "60+",
                backgroundColor: 'rgb(54, 162, 235)',
                borderColor: 'rgb(54, 162, 235)',
                data: valuesMap.scores60s,
                fill: false
            },
            {
                label: "100+",
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: valuesMap.scores100s,
                fill: false
            },
            {
                label: "140+",
                backgroundColor: 'rgb(255, 159, 64)',
                borderColor: 'rgb(255, 159, 64)',
                data: valuesMap.scores140s,
                fill: false
            },
            {
                label: "180",
                backgroundColor: 'rgb(153, 102, 255)',
                borderColor: 'rgb(153, 102, 255)',
                data: valuesMap.scores180s,
                fill: false
            }]
            var scoresChart = new Chart("canvas-scores", getChartConfig('Scores Per Week|', 'line', 'Date', 'Count', labels, datasetsScores));
        });

block content
    h2(style='padding: 10px 0px 20px 0px;') Statistics for #{player.name}

    ul(class="nav nav-pills")
        li(role="presentation" class="active"): a(href="#overview" data-toggle="tab") Overview
        li(role="presentation"): a(href="#highscores" data-toggle="tab") High scores
        li(role="presentation"): a(href="#accuracy" data-toggle="tab") Accuracy
        li(role="presentation"): a(href="#hits" data-toggle="tab") Hits
        li(role="presentation"): a(href="#progression" data-toggle="tab") Progression
        li(role="presentation"): a(href="#heatmap" data-toggle="tab") Heatmap

    div(class='tab-content' style='padding-top: 20px;')
        div(role='tabpanel' id='overview' class="tab-pane active")
            table(id='table-overview' style='width: 100%;')
                tr
                    td(class='glyph')
                        span(class="glyphicon glyphicon-signal" aria-hidden="true")
                    td(class='glyph')
                        span(class="glyphicon glyphicon-star" aria-hidden="true")
                    td(class='glyph')
                        span(class="glyphicon glyphicon-adjust" aria-hidden="true")
                tr
                    td(class='number')= player.games_played
                    td(class='number')= player.games_won
                    td(class='number')= player.games_played == 0 ? 0 : (player.games_won * 100 / player.games_played).toFixed(2)
                tr
                    td(class='olabel') Played
                    td(class='olabel') Won
                    td(class='olabel') Win %
                tr
                    td
                        hr
                    td
                        hr
                    td
                        hr
                tr
                    td(class='glyph')
                        span(class="glyphicon glyphicon-th" aria-hidden="true")
                    td(class='glyph')
                        span(class="glyphicon glyphicon-list-alt" aria-hidden="true")
                    td(class='glyph')
                        span(class="glyphicon glyphicon glyphicon-screenshot" aria-hidden="true")
                tr            
                    td(class='number')= statistics.first_nine_ppd.toFixed(2)
                    td(class='number')= statistics.ppd.toFixed(2)
                    td(class='number')= player.games_won === 0 ? '-' : statistics.checkout_percentage.toFixed(2) + '%'
                tr
                    td(class='olabel') First 9 PPD
                    td(class='olabel') Overall PPD
                    td(class='olabel') Checkout%  
                tr
                    td
                        hr
                    td 
                        hr
                    td
                        hr                      

        div(role='tabpanel' id='highscores' class="tab-pane")
            table(id='table-highscores')
                tr
                    td(class='glyph glyph60')
                        span(class="glyphicon glyphicon-fire" aria-hidden="true")
                    td(class='glyph glyph100')
                        span(class="glyphicon glyphicon-fire" aria-hidden="true")
                    td(class='glyph glyph140')
                        span(class="glyphicon glyphicon-fire" aria-hidden="true")
                    td(class='glyph glyph180')
                        span(class="glyphicon glyphicon-fire" aria-hidden="true")
                tr
                    td(class='number')= statistics.scores_60s_plus
                    td(class='number')= statistics.scores_100s_plus
                    td(class='number')= statistics.scores_140s_plus
                    td(class='number')= statistics.scores_180s
                tr
                    td(class='olabel') 60+
                    td(class='olabel') 100+
                    td(class='olabel') 140+
                    td(class='olabel') 180
                tr
                    td
                        hr
                    td 
                        hr
                    td
                        hr
                    td
                        hr
                tr
                    td(class='glyph')
                        span(class="glyphicon glyphicon-tasks" aria-hidden="true")
                    td(class='glyph txt-italic') 301
                    td(class='glyph txt-italic') 501
                    td(class='glyph')
                        span(class="glyphicon glyphicon-screenshot" aria-hidden="true")
                tr            
                    td(class='number')= statistics.best_ppd.toFixed(2) + ' / ' + statistics.best_first_nine_ppd.toFixed(2)
                    td(class='number')= statistics.best_301
                    td(class='number')= statistics.best_501
                    td(class='number')= statistics.highest_checkout
                tr
                    td(class='olabel') Best PPD / First 9
                    td(class='olabel') Best 301
                    td(class='olabel') Best 501
                    td(class='olabel') Highest Checkout  
                tr
                    td
                        hr
                    td 
                        hr
                    td
                        hr
                    td
                        hr

        div(role='tabpanel' id='accuracy' class="tab-pane")
            table(id='table-accuracy')
                tr
                    td(class='number')= statistics.accuracy_overall === null ? 'Not Available' : statistics.accuracy_overall.toFixed(2)
                    td(class='number')= statistics.accuracy_20 === null ? 'Not Available' : statistics.accuracy_20.toFixed(2)
                    td(class='number')= statistics.accuracy_19 === null ? 'Not Available' : statistics.accuracy_19.toFixed(2)
                tr
                    td(class='olabel') Overall Accuracy
                    td(class='olabel') Accuracy 20s
                    td(class='olabel') Accuracy 19s                          

        div(role='tabpanel' id='hits' class="tab-pane")
            table(id='player-hits-table' class='table')
                thead
                    tr
                        th Dart
                        th Count
                        th Hit %
                tbody
                    each score, key in statistics.hits
                        each value, multiplier in statistics.hits[key]
                            tr
                                td(class='col-sm-2 dart-score-container' data-order=key + multiplier)
                                    if multiplier == 3
                                        label(class='dart-score-triple')= 'T-' + key
                                    else if multiplier == 2
                                        if key == 25
                                            label(class='dart-score-double') Bull
                                        else
                                            label(class='dart-score-double')= 'D-' + key
                                    else
                                        if key == 0
                                            label(class='dart-score-single') Miss
                                        else if key == 25
                                            label(class='dart-score-single') Bull
                                        else
                                            label(class='dart-score-single')= key
                                td= value
                                td= (value * 100 / statistics.darts_thrown).toFixed(2) + '%'

        div(role='tabpanel' id='heatmap' class="tab-pane")
            select(id='heatmap-value-selector' name='dart-values')
                option(value=0 default=true) All
                option(value=1) Singles
                option(value=2) Doubles
                option(value=3) Trebles
            div(style='text-align: center;')
                canvas(id='dartboard-heatmap')

        div(role='tabpanel' id='progression' class="tab-pane")
            div
                h3 PPD
                canvas(id="canvas-ppd")
            div
                h3 Scores
                canvas(id="canvas-scores")
