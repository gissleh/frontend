extends layout.pug

include mixins/dart.pug
include mixins/player.pug

block append head
    link(rel='stylesheet' type='text/css' href='/stylesheets/datatables-1.10.16.min.css')
    script(src='/javascripts/datatables-1.10.16.min.js')

    script(src='/javascripts/Chart.bundle-2.7.1.min.js')
    script(src='/javascripts/webgl-heatmap.js')
    script(src='/javascripts/jquery-ui.1.12.1.min.js')
    script(src='/javascripts/jquery.ui.touch-punch-0.2.3.min.js')
    script(src='/javascripts/moment-2.20.1.min.js')

block append scripts
    script
        include chart/chart_helper.js
    script.
        var leg = !{JSON.stringify(leg)}
        var match = !{JSON.stringify(match)}
        var legPlayers = !{JSON.stringify(leg_players)}
        var playersMap = !{JSON.stringify(players)}
        var visits = leg.visits;

        var chartMaxValue = match.match_type.id == 1 || match.match_type.id == 3 ? leg.starting_score : 0;
        var labels = [];
        var values = { }
        for (var i = 0; i < legPlayers.length; i++) {
            var player = legPlayers[i];
            var score = leg.starting_score + player.handicap
            values[player.player_id] = [ score ];
            if (score > chartMaxValue) {
                chartMaxValue = score;
            }
        }
        var round = 0;
        labels.push(round);

        for (var i = 0; i < visits.length; i++) {
            var visit = visits[i];
            if (i % legPlayers.length === 0) {
                round++;
                labels.push(round);
            }
            var current = values[visit.player_id][values[visit.player_id].length - 1];
            if (visit.is_bust) {
                values[visit.player_id].push(current);
            }
            else {
                var visitScore = ((visit.first_dart.value * visit.first_dart.multiplier) +
                    (visit.second_dart.value * visit.second_dart.multiplier) +
                    (visit.third_dart.value * visit.third_dart.multiplier))
                if (match.match_type.id == 2) {
                    current = current + visitScore
                    values[visit.player_id].push(current);
                    if (current > chartMaxValue) {
                        chartMaxValue = current;
                    }
                }
                else {
                    values[visit.player_id].push(current - visitScore);
                }
            }
        }

        $(function () {
            var datasets = []
            for (var i = 0; i < legPlayers.length; i++) {
                var player = playersMap[legPlayers[i].player_id];
                datasets.push({
                    label: player.name,
                    backgroundColor: player.color,
                    borderColor: player.color,
                    data: values[player.id],
                    fill: false
                });
            }
            var config = getChartConfig('Scores', 'line', 'Round', 'Scores', labels, datasets);
            config.options.scales.yAxes[0].ticks = { max: chartMaxValue, stepSize: 20, beginAtZero: true };
            var scoresChart = new Chart("canvas-scores", config);
        });
    script.
        var leg = !{JSON.stringify(leg)}

        $(function () {
            $('#leg-hits-table').DataTable({
                searching: false,
                bInfo : false,
                iDisplayLength: 50,
                order: [[ 1,  'desc' ]]
            });
            $('#continue-match').focus();

            $('.edit-visit').click(function () {
                var visitNumber = $(this).data('visit');

                var firstDartField = $('#first-dart-visit-' + visitNumber);
                var secondDartField = $('#second-dart-visit-' + visitNumber);
                var thirdDartField = $('#third-dart-visit-' + visitNumber);

                var firstDartValue = firstDartField.data().score;
                var firstDartMultiplier = firstDartField.data().multiplier;
                var secondDartValue = secondDartField.data().score;
                var secondDartMultiplier = secondDartField.data().multiplier;
                var thirdDartValue = thirdDartField.data().score;
                var thirdDartMultiplier = thirdDartField.data().multiplier;

                var selector1 = $('#first-dart-visit-' + visitNumber + '-selector');
                var selector2 = $('#second-dart-visit-' + visitNumber + '-selector');
                var selector3 = $('#third-dart-visit-' + visitNumber + '-selector');

                var firstDartLabel = $('#first-dart-visit-' + visitNumber + '-label');
                var secondDartLabel = $('#second-dart-visit-' + visitNumber + '-label');
                var thirdDartLabel = $('#third-dart-visit-' + visitNumber + '-label');

                if ($(this).data('issave') == 1) {
                    var newFirstDart = selector1.val().split('-');
                    var newSecondDart = selector2.val().split('-');
                    var newThirdDart = selector3.val().split('-');

                    var firstScoreChanged = newFirstDart[1];
                    var secondScoreChanged = newSecondDart[1];
                    var thirdScoreChanged = newThirdDart[1];

                    var firstMultiplierChanged = newFirstDart[0];
                    var secondMultiplierChanged = newSecondDart[0];
                    var thirdMultiplierChanged = newThirdDart[0];

                    firstDartField.data('score', firstScoreChanged);
                    firstDartField.data('multiplier', firstMultiplierChanged);
                    secondDartField.data('score', secondScoreChanged);
                    secondDartField.data('multiplier', secondMultiplierChanged);
                    thirdDartField.data('score', thirdScoreChanged);
                    thirdDartField.data('multiplier', thirdMultiplierChanged);

                    // Save the data
                    var data = JSON.stringify({
                        id: visitNumber,
                        leg_id: leg.id,
                        first_dart: { value: parseInt(firstScoreChanged), multiplier: parseInt(firstMultiplierChanged) },
                        second_dart: { value: parseInt(secondScoreChanged), multiplier: parseInt(secondMultiplierChanged) },
                        third_dart: { value: parseInt(thirdScoreChanged), multiplier: parseInt(thirdMultiplierChanged) }
                    });
                    $(this).children('span').removeClass('glyphicon-floppy-disk').addClass('glyphicon-edit');
                    $(this).data('issave', 0);

                    /// Depending on the data-finished attribute of submit button, use different route and redirect
                    var route = window.location.pathname;
                    var routeRedirect = window.location.pathname;
                    executePost(route, data, 'application/json',
                        function (response) {
                            location.href = '/legs/' + leg.id;
                        },
                        function (error) {
                            alert("Error when updating score, please reload!");
                            console.log("Unable to proceed: " + error.responseText);
                            location.reload();
                        }
                    )
                }
                else {
                    selector1.show();
                    selector2.show();
                    selector3.show();

                    selector1.val(firstDartMultiplier + "-" + firstDartValue);
                    selector2.val(secondDartMultiplier + "-" + secondDartValue);
                    selector3.val(thirdDartMultiplier + "-" + thirdDartValue);

                    firstDartLabel.hide();
                    secondDartLabel.hide();
                    thirdDartLabel.hide();

                    $(this).children('span').removeClass('glyphicon-edit').addClass('glyphicon-floppy-disk');
                    $(this).data('issave', 1);
                }
            });

            $('.delete-visit').click(function () {
                var visitNumber = $(this).data('visit');
                showConfirm('Visit will be deleted.', function() {
                    executeDelete('/legs/' + leg.id + '/visit/' + visitNumber,
                        function (response) {
                            location.href = '/legs/' + leg.id;
                        },
                        function (error) {
                            alert('Error deleting score. Please reload');
                            console.log("Unable to proceed: " + error.responseText);
                            location.reload();
                        }
                    );
                }, function(){ /* NOOP */ });
            });

            $('#change-order-button').click(function (e) {
                var players = $('.form-check-input');
                var order = {}
                order = {};
                for (var i = 0; i < players.length; i++) {
                    order[players[i].value] = i + 1;
                }
                executePut(window.origin + '/legs/' + leg.id + '/order', JSON.stringify(order), 'application/json', function() {
                    location.href = '/legs/' + leg.id;
                },
                function(error) {
                    alert('Error changing player order. Please reload');
                    console.log(error);
                    location.reload();
                })
            });

            $('#player-order-list').sortable();
            $('#player-order-list').disableSelection();

            $('#continue-match').click(function () {
                location.href = '/matches/' + $(this).data('match');
            });
            $('#back-to-match').click(function () {
                location.href = '/matches/' + $(this).data('match') + '/result';
            });

            $('.glyphicon-user').click(function(){
                location.href = '/players/' + $(this).data('player') + '/statistics'
            });

            $('#button-undo-finish').click(function () {
                showConfirm('Leg will no longer be finalized', function() {
                    executePut('/legs/' + leg.id + '/undo', null, 'application/json',
                        function (response) {
                            location.href = '/legs/' + leg.id;
                        },
                        function (error) {
                            alert.show();
                            alert.text('Unable to undo leg fomosj, see log for details (' + error.statusText + ')');
                        }
                    );
                }, function(){ /* NOOP */ });
            });
        });
    script.
        var scoresMap = !{JSON.stringify(leg.hits)};
        $(function () {
            var canvas = $('#dartboard-heatmap')[0];
            drawHeatmap(canvas, scoresMap, 0, 20, 20, 50);
            $("#heatmap-value-selector").change(function () {
                drawHeatmap(canvas, scoresMap, this.value, 20, 20, 50);
            });

            $('#btn-collapse-visits').click(function () {
                if ($('#visits-div').hasClass('in')) {
                    $('#btn-collapse-visits').text('Show Visits');
                } else {
                    $('#btn-collapse-visits').text('Hide Visits');
                }
            });
            $('#btn-collapse-heatmap').click(function () {
                if ($('#heatmap-div').hasClass('in')) {
                    $('#btn-collapse-heatmap').text('Show Heatmap');
                } else {
                    $('#btn-collapse-heatmap').text('Hide Heatmap');
                }
            });
            $('#btn-collapse-hits').click(function () {
                if ($('#hits-div').hasClass('in')) {
                    $('#btn-collapse-hits').text('Show Hits');
                } else {
                    $('#btn-collapse-hits').text('Hide Hits');
                }
            });
            $('#btn-collapse-checkouts').click(function () {
                if ($('#checkouts-div').hasClass('in')) {
                    $('#btn-collapse-checkouts').text('Show Checkouts');
                } else {
                    $('#btn-collapse-checkouts').text('Hide Checkouts');
                }
            });
            $('#heatmap-div').on('shown.bs.collapse', function() {
                drawHeatmap(canvas, scoresMap, 0, 20, 20, 50);
            });
        });

block content
    div(class='clearfix')
        h2(style='margin-bottom: 5px;' class='pull-left') Leg Result (#{leg.id})

        div(class='pull-right' style='padding-top: 20px;')
            if match.is_finished
                button(type='button' class='btn btn-primary pull-right mt-30' id='back-to-match' data-match=leg.match_id) Back to Match
            else
                button(type='button' class='btn btn-primary pull-right mt-30' id='continue-match' data-match=match.id) Continue Match

    p.
        Started: #{moment(leg.created_at).format('YYYY-MM-DD HH:mm:ss')} <br>
        Finished: #{leg.end_time === null ? '' : moment(leg.end_time).format('YYYY-MM-DD HH:mm:ss')} <br>
        Duration: #{leg.end_time === null ? '' : moment.duration(moment(leg.end_time).diff(leg.visits[0].created_at)).asMinutes().toFixed() + ' minutes'} <br>
        Rounds: #{Math.ceil(leg.visits.length / leg.players.length)}

    - var isFinished = leg.winner_player_id !== null
    if isFinished
        div(class='btn-group')
            button(type='button' class='btn btn-primary') Options
            button(type='button' class='btn btn-primary btn-blcok dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false')
                span(class='caret')
                span(class='sr-only')
            ul(class='dropdown-menu')
                block advanced_options
                    li: a(id='button-undo-finish') Undo Leg Finish

    if isFinished
        table(style='width: 100%; table-layout: fixed;')
            tbody
                tr
                    each statistic in stats
                        - var player = players[statistic.player_id]
                        td(class='text-center')
                            - var dartsThrown = 0
                            - var isWinner = statistic.player_id === leg.winner_player_id
                            +player_statistics_card('player-card', player, statistic, isWinner, statistic.darts_thrown, player.starting_score)
    h3 Leg Results
    p.
        Starting score was #{leg.starting_score}, and a total of #{leg.darts_thrown ? leg.darts_thrown : 0} darts were thrown by #{leg.players.length} players

    if isFinished
        button(id='btn-collapse-visits' class='btn btn-primary btn-block' data-toggle='collapse' data-target='#visits-div')= isFinished ? 'Show Visits' : 'Hide Visits'
    div(id='visits-div' class=isFinished ? 'collapse' : 'collapse in')
        table(class='table' id='table-leg-visits')
            thead
                tr
                    th Player
                    th First Dart
                    th Second Dart
                    th Third Dart
                    th Total
                    th Remaining
                    th Thrown
                    th PPD
                    if !isFinished
                        th(class='text-center') Options
            tbody
                each visit in leg.visits
                    - var visit_score = (visit.first_dart.value * visit.first_dart.multiplier) + (visit.second_dart.value * visit.second_dart.multiplier) + (visit.third_dart.value * visit.third_dart.multiplier)
                    tr(id='visit-' + visit.id)
                        td= players[visit.player_id].name

                        +dart_container(visit.first_dart.value, visit.first_dart.multiplier, 'first-dart-visit-' + visit.id, true)
                        +dart_container(visit.second_dart.value, visit.second_dart.multiplier, 'second-dart-visit-' + visit.id, true)
                        +dart_container(visit.third_dart.value, visit.third_dart.multiplier, 'third-dart-visit-' + visit.id, true)

                        td(class='total-visit-score-' + visit.id): label= visit_score
                        td: label= visit.scores
                        td= visit.darts_thrown
                        td(class='visit-ppd-' + visit.id)= (visit_score / 3).toFixed(2)
                        if !isFinished
                            td(class='text-center')
                                button(type="button" class="btn btn-default edit-visit" data-visit=visit.id data-issave='0')
                                    span(class="glyphicon glyphicon-edit" aria-hidden="true")
                                button(type="button" class="btn btn-default delete-visit" data-visit=visit.id)
                                    span(class="glyphicon glyphicon-trash" aria-hidden="true")
    br
    - var checkouts = leg.checkout_statistics
    if checkouts.checkout_attempts
        button(id='btn-collapse-checkouts' class='btn btn-primary btn-block' data-toggle='collapse' data-target='#checkouts-div') Show Checkouts
        div(id='checkouts-div' class='collapse')
            h3 Checkout Attempts
            div(class='table-responsive')
                table(id='table-leg-checkouts' class='table')
                    thead
                        tr
                            th Dart
                            th Count
                            th Attempt %
                            th Actual
                    tbody
                        each count, value in checkouts.checkout_attempts
                            tr
                                +dart_container(value / 2, 2)
                                td= count
                                td= (count * 100 / checkouts.count).toFixed(2) + '%'
                                if value == checkouts.checkout
                                    td: span(class='glyphicon glyphicon-ok' aria-hidden='true')
                                else
                                    td
    br
    if !isFinished
        h3 Player Order
        div
            div(id='player-order-list')
                each id in leg.players
                    div(class='float-left')
                        input(style='display: none;' type='checkbox' class='form-check-input' id='checkbox-player-' + players[id].id value=players[id].id)
                        label(style='margin-left: 10px; width: 160px;' class='player-name-label form-check-label btn btn-warning' for='checkbox-player-' + players[id].id)= players[id].name
            button(type='submit' name='submit' style='margin-left: 10px' id='change-order-button' class='btn btn-primary') Change Order
    div
        h3 Scores
        canvas(id='canvas-scores')
    br
    button(id='btn-collapse-heatmap' class='btn btn-primary btn-block' data-toggle='collapse' data-target='#heatmap-div') Show Heatmap
    div(id='heatmap-div' class='collapse')
        h3 Leg Heatmap
        select(id='heatmap-value-selector' name='dartValues')
            option(value=0 default=true) All
            option(value=1) Singles
            option(value=2) Doubles
            option(value=3) Trebles
        div(style='text-align: center;')
            canvas(id='dartboard-heatmap')

    br
    button(id='btn-collapse-hits' class='btn btn-primary btn-block' data-toggle='collapse' data-target='#hits-div') Show Hits
    div(id='hits-div' class='collapse')
        h3 Hits
        div(class='table-responsive')
            table(id='leg-hits-table' class='table')
                thead
                    tr
                        th Dart
                        th Count
                        th Hit %
                tbody
                    each score, key in leg.hits
                        each count, multiplier in leg.hits[key]
                            if count !== 0
                                tr
                                    +dart_container(key, multiplier)
                                    td= count
                                    td= (count * 100 / leg.darts_thrown).toFixed(2) + '%'
    br